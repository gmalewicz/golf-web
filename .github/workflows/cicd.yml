name: CI for golf-web

on:
  push:
    branches: [ master ]
    tags:
     - '**'
  pull_request:
    branches: [ master ]

env:
  IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}
  ORGANIZATION: ${{ github.repository_owner }}
  VERSION_EXP: git describe --tags --always --first-parent --dirty

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Node ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: 14.x

      - name: npm install and npm run build
        run: |
          npm i
          npm run build:prod

      - name: Set up version
        #if: always()
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "VERSION=$($VERSION_EXP)" >> $GITHUB_ENV

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITAL_OCEAN_TOKEN }}

      - name: Build container image
        run: docker build -t registry.digitalocean.com/golf/golf-web:$(echo $GITHUB_SHA | head -c7) .

      - name: Log in to DigitalOcean Container Registry with short-lived credentials
        run: doctl registry login --expiry-seconds 1200

      - name: Push image to DigitalOcean Container Registry
        run: docker push registry.digitalocean.com/golf/golf-web:$(echo $GITHUB_SHA | head -c7)

      - name: Update deployment file
        run: TAG=$(echo $GITHUB_SHA | head -c7) && sed -i 's|<IMAGE>|registry.digitalocean.com/golf/golf-web:'${TAG}'|' $GITHUB_WORKSPACE/config/deployment.yml

      - name: Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 golf

      # temporary as node is very small
      - name: Remove existing deployment
        run: kubectl delete deployment golf-web

      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f $GITHUB_WORKSPACE/config/deployment.yml

      - name: Verify deployment
        run: kubectl rollout status deployment/golf-web

#      - name: Assemble image
#        #if: always()
#        if: startsWith(github.ref, 'refs/tags/')
#        run: docker build -t $IMAGE:$VERSION -t $IMAGE:latest .

#      - name: Publish image
#        if: startsWith(github.ref, 'refs/tags/')
#        #if: always()
#        run: |
#          echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u $ORGANIZATION --password-stdin
#          docker push $IMAGE:$VERSION
#          docker push $IMAGE:latest

#      - name: Set up Google Cloud SDK
#        if: startsWith(github.ref, 'refs/tags/')
#        #if: always()
#        uses: google-github-actions/setup-gcloud@master
#        with:
#          service_account_key: ${{ secrets.GCP_SA_KEY }}
#          export_default_credentials: true

#      - name: Copy build file to Google Cloud Storage
#        if: startsWith(github.ref, 'refs/tags/')
#        #if: always()
#        uses: google-github-actions/upload-cloud-storage@main
#        with:
#          path:   /home/runner/work/golf-web/golf-web/dist/golf-web
#          destination: drungolfersweb
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      # Install NPM dependencies, cache them correctly
      # and run all Cypress tests
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          build: npm run build
          start: npm start
